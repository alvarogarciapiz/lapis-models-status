name: "Model Availability Check"

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  check-availability:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check and update availability
        run: |
          # Initialize variables
          total_models=$(jq length models.json)
          unavailable_count=0
          start_time=$(date +"%Y-%m-%d %H:%M:%S UTC")
          
          # Reset availability
          jq 'map(.available="true")' models.json > updatedModels.json
          unavailable_urls=""
          
          for url in $(jq -r '.[].url' models.json); do
            if ! curl --head --silent --fail "$url" > /dev/null; then
              modelId=$(jq -r ".[] | select(.url==\"$url\").modelId" models.json)
              index=$(jq -r "to_entries | map(select(.value.modelId==\"$modelId\")) | .[0].key" updatedModels.json)
              [ -n "$index" ] && jq ".[$index].available=\"false\"" updatedModels.json > temp.json && mv temp.json updatedModels.json
              unavailable_urls="$unavailable_urls\n$url"
              ((unavailable_count++))
            fi
          done
          mv updatedModels.json models.json
          
          # Calculate percentages
          available_count=$((total_models-unavailable_count))
          availability_percentage=$(awk "BEGIN {print ($available_count/$total_models)*100}")
          
          # Create enhanced summary
          {
            echo "# 🔄 Model Availability Report"
            echo
            echo "### 📊 Statistics"
            echo "- **Check Time**: $start_time"
            echo "- **Total Models**: $total_models"
            echo "- **Available**: $available_count ($(printf "%.1f" $availability_percentage)%)"
            echo "- **Unavailable**: $unavailable_count"
            echo
            if [ $unavailable_count -gt 0 ]; then
              echo "### ⚠️ Unavailable Models"
              echo "\`\`\`"
              echo -e "$unavailable_urls"
              echo "\`\`\`"
            else
              echo "### ✅ All Models Available"
              echo "All model endpoints are responding correctly."
            fi
          } >> $GITHUB_STEP_SUMMARY

      - name: Commit changes if any
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions"
            git config user.email "actions@github.com"
            git add models.json
            git commit -m "Update model availability"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
          fi
